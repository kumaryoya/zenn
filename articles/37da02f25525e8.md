---
title: "ã€AWSã€‘AWS WAF ã§æµ·å¤–ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã—ã¦ã¿ãŸ"
emoji: "ğŸ”¥"
type: "tech"
topics: [aws, waf, security, firewall, web]
published: false
publication_name: "linkedge"
---

## ã¯ã˜ã‚ã«

é‹å–¶ã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ã—ãŸã¨ã“ã‚ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã® CPU ãŒä¸€æ™‚çš„ã«é«˜é¨°ã—ã¦ã„ã‚‹ã“ã¨ãŒä½•åº¦ã‹ã‚ã‚Šã¾ã—ãŸã€‚

ãƒ­ã‚°ã‚’ç¢ºèªã—ãŸã¨ã“ã‚ã€æµ·å¤–ã‹ã‚‰çŸ­æ™‚é–“ã§å¤§é‡ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒã‚ã‚Šã€ã“ã‚ŒãŒåŸå› ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

ãã“ã§ã€AWS WAF ã‚’å°å…¥ã—ã€æµ·å¤–ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

ä»Šå›ã€AWS WAF ã‚’ä½¿ç”¨ã™ã‚‹ã®ã¯åˆã‚ã¦ã ã£ãŸã®ã§ã€æ¦‚è¦ã‚„ä½¿ç”¨æ–¹æ³•ã‚’èª¿ã¹ãªãŒã‚‰é€²ã‚ã¾ã—ãŸã€‚

æœ¬è¨˜äº‹ã¯ã€ãã‚Œã‚‰ã®å†…å®¹ã‚’å‚™å¿˜éŒ²ã‚‚å…¼ã­ã¦ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚

å°‘ã—ã§ã‚‚çš†æ§˜ã®å‚è€ƒã«ãªã‚Šã¾ã™ã¨å¹¸ã„ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/80ac4317ac30-20250726.png =200x)

## æ³¨æ„ç‚¹

:::message alert
- å†…å®¹ã«èª¤ã‚ŠãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
- ã‚³ãƒ¡ãƒ³ãƒˆãªã©ã§ã”æŒ‡æ‘˜ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™
:::

## AWS WAF ã¨ã¯

### æ¦‚è¦

AWS WAFï¼ˆWeb Application Firewallï¼‰ã¨ã¯ã€AWS ãŒæä¾›ã™ã‚‹ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä¿è­·ã™ã‚‹ãŸã‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚

è¨­å®šã—ãŸãƒ«ãƒ¼ãƒ«ã«åŸºã¥ã„ã¦ã€Web ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã€ãƒ–ãƒ­ãƒƒã‚¯ã€ç›£è¦–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä¿è­·ã§ãã‚‹ä¸»ãªãƒªã‚½ãƒ¼ã‚¹ã«ã¯ Amazon CloudFrontã€Application Load Balancerï¼ˆALBï¼‰ã€Amazon API Gateway ãªã©ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®ã‚ˆã†ãªãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦é©åˆ‡ãªãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€ã‚µãƒ¼ãƒãƒ¼ã¸ã‚¢ã‚¯ã‚»ã‚¹ãŒå±Šãå‰ã«ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://aws.amazon.com/jp/waf

### ã‚³ã‚¹ãƒˆ

AWS WAF ã®ã‚³ã‚¹ãƒˆä½“ç³»ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

AWS WAF ã‚’å°å…¥ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹å›æ•°ã‚„ã€è¨­å®šå†…å®¹ã«ã‚ˆã£ã¦ã‚³ã‚¹ãƒˆãŒå¤‰å‹•ã™ã‚‹ãŸã‚ã€äº‹å‰ã«ã©ã‚Œãã‚‰ã„ã®ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‹ã®ã‹ã‚’è©¦ç®—ã—ã¦ãŠãã“ã¨ãŒé‡è¦ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/5029c92ccac9-20250730.png =1000x)

https://aws.amazon.com/jp/waf/pricing

## AWS WAF ã‚’è¨­å®šã™ã‚‹

### è¨­å®šå‰

ä»Šå›ã¯ã€æµ·å¤–ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’å†ç¾ã™ã‚‹ãŸã‚ã« Google Apps Script ã‚’ä½¿ç”¨ã—ã¦ã¿ã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã€æŒ‡å®šã® URL ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆã® HTTP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¾ã™ã€‚

```javascript
function fetchAndLogStatusCode() {
  const url = 'XXXXXXXXXX';

  const response = UrlFetchApp.fetch(url, { "muteHttpExceptions": true });

  const statusCode = response.getResponseCode();

  Logger.log('HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ï¼š' + statusCode);
}
```

å®Ÿè¡Œã—ãŸã¨ã“ã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ­ã‚°ã«å‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚

```javascript
HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ï¼š200
```

ã¾ãŸã€ã‚µãƒ¼ãƒãƒ¼ã®ãƒ­ã‚°ã‹ã‚‰ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã—ã€å›½ã‚’ç¢ºèªã—ãŸã¨ã“ã‚ã€ã‚¢ãƒ¡ãƒªã‚«ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚

ã¾ã  AWS WAF ã‚’è¨­å®šã—ã¦ã„ãªã„ãŸã‚ã€æµ·å¤–ã‹ã‚‰ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¦ã„ã‚‹çŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

### è¨­å®šæ‰‹é †

ã§ã¯ã€å®Ÿéš›ã« AWS WAF ã‚’è¨­å®šã—ã¦ã„ãã¾ã™ã€‚

ä»Šå›ã¯ã€æ—¥æœ¬ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿ã‚’è¨±å¯ã—ã€ãã‚Œä»¥å¤–ã¯å…¨ã¦ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

AWS ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã€AWS WAF ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ã€ŒCreate web ACLã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/11867663035d-20250730.jpg =1000x)

æ¬¡ã«ã€ä»¥ä¸‹ã®é …ç›®ã‚’é †ã«é¸æŠãƒ»å…¥åŠ›ã—ã¦ã„ãã¾ã™ã€‚

- **Resource type**ï¼šAWS WAF ã‚’è¨­å®šã—ãŸã„ãƒªã‚½ãƒ¼ã‚¹ã«å¿œã˜ã¦ã€Global resources ã¾ãŸã¯ Regional resources ã‚’é¸æŠã—ã¾ã™ã€‚

- **Region**ï¼šResource type ã§ Regional resources ã‚’é¸æŠã—ãŸå ´åˆã€å¯¾è±¡ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠã—ã¾ã™ã€‚

- **Name**ï¼šWeb ACL ã®åå‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

- **CloudWatch metric name**ï¼šWeb ACL ã§ä½¿ç”¨ã™ã‚‹ CloudWatch ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹åã‚’å…¥åŠ›ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/691074207509-20250730.jpg =1000x)

- **Associated AWS resources**ï¼šAWS WAF ã‚’è¨­å®šã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’é¸æŠã—ã¾ã™ã€‚

- **Resource level DDoS protection**ï¼šAssociated AWS resources ã§ Application Load Balancer ã‚’é¸æŠã—ãŸå ´åˆã€DDoS ä¿è­·ã®ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/d2dad8fa44d4-20250730.jpg =1000x)

ã“ã“ã¾ã§é¸æŠãƒ»å…¥åŠ›ã—ãŸã‚‰ã€ã€ŒNextã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

æ¬¡ã«ã€ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¾ã™ã€‚

ã€ŒAdd rulesã€>ã€ŒAdd my own rules and rule groupsã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/07418c731e79-20250730.jpg =1000x)

- **Rule type**ï¼šãƒ«ãƒ¼ãƒ«ã®ç¨®é¡ã‚’é¸æŠã—ã¾ã™ã€‚ä»Šå›ã¯ã€ŒRule builderã€ã‚’é¸æŠã—ã¾ã™ã€‚

- **Rule**
  - **Name**ï¼šãƒ«ãƒ¼ãƒ«ã®åå‰ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
  - **Type**ï¼šã€ŒRegular ruleã€ã‚’é¸æŠã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/eb274cf9a85e-20250730.jpg =1000x)

- **If a request**ï¼šmatches the statement ã‚’é¸æŠã—ã¾ã™ã€‚

- **Statement**
  - **Inspect**ï¼šOriginates from a country in ã‚’é¸æŠã—ã¾ã™ã€‚
  - **Country codes**ï¼šJapan - JP ã‚’é¸æŠã—ã¾ã™ã€‚
  - **IP address to use to determine the country of origin**ï¼šSource IP address ã‚’é¸æŠã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/46d40e2b9ef9-20250730.jpg =1000x)

- **Action**ï¼šAllow ã‚’é¸æŠã—ã¾ã™ã€‚

ã€ŒAdd ruleã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/75209fa3d937-20250730.jpg =1000x)

- **Default action**ï¼šBlock ã‚’é¸æŠã—ã¾ã™ã€‚

ã€ŒNextã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/73f8b7329bf9-20250730.jpg =1000x)

ã€ŒNextã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/d8bd222959de-20250730.jpg =1000x)

ã€ŒNextã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/a3405336f373-20250730.jpg =1000x)

æœ€å¾Œã«ã€è¨­å®šå†…å®¹ã‚’ç¢ºèªã—ã€ã€ŒCreate web ACLã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

ã“ã‚Œã§ AWS WAF ã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚

### è¨­å®šå¾Œ

ã§ã¯ã€å…ˆã»ã©ã® Google Apps Script ã®ã‚³ãƒ¼ãƒ‰ã‚’å†åº¦å®Ÿè¡Œã—ã€HTTP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¾ã™ã€‚

```javascript
function fetchAndLogStatusCode() {
  const url = 'XXXXXXXXXX';

  const response = UrlFetchApp.fetch(url, { "muteHttpExceptions": true });

  const statusCode = response.getResponseCode();

  Logger.log('HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ï¼š' + statusCode);
}
```

å®Ÿè¡Œã—ãŸã¨ã“ã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ­ã‚°ã«å‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚

```javascript
HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ï¼š403
```

ç„¡äº‹ã«æµ·å¤–ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

## ã¾ã¨ã‚

AWS WAF ã‚’ä½¿ç”¨ã—ã¦ã€æµ·å¤–ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã—ãŸã€‚

æµ·å¤–ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶é™ã™ã‚‹ã“ã¨ã§ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é¢ã ã‘ã§ãªãã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é¢ã«ãŠã„ã¦ã‚‚åŠ¹æœãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚

ç°¡å˜ã«è¨­å®šã§ãã‚‹ã®ã§ã€ãœã²è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

æœ€å¾Œã¾ã§ã”è¦§ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚

<!-- ## å‚è€ƒæ–‡çŒ® -->

<!-- https://www.netassist.ne.jp/techblog/25475 -->

<!-- https://blog.serverworks.co.jp/aws-waf-block-from-overseas-countries -->
