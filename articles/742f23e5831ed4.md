---
title: "ã€Railsã€‘gemä½¿ã£ã¦ã¿ãŸã‚·ãƒªãƒ¼ã‚º ã€œparallelç·¨ã€œ ä¸¦åˆ—å‡¦ç†ã§æ™‚é–“çŸ­ç¸®"
emoji: "ğŸ”±"
type: "tech"
topics: [rails, ruby, gem, parallel, ä¸¦åˆ—å‡¦ç†]
published: false
publication_name: "linkedge"
---

## ã¯ã˜ã‚ã«

å…ˆæ—¥ã€Ruby on Rails ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã€ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆã—ã€ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ã‚¸ãƒ§ãƒ–ã®å®Ÿè£…ã‚’ã—ã¾ã—ãŸã€‚

1ã¤1ã¤ã®é›†è¨ˆã¯ãã‚Œã»ã©æ™‚é–“ãŒã‹ã‹ã‚‰ãªã„ã®ã§ã™ãŒã€è¤‡æ•°ã®é›†è¨ˆã‚’è¡Œã†ãŸã‚ã€å…¨ä½“ã®å‡¦ç†æ™‚é–“ãŒé•·ããªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚

ãã“ã§ã€parallel ã¨ã„ã† gem ã‚’ä½¿ã£ã¦ä¸¦åˆ—å‡¦ç†ã‚’è¡Œã£ãŸã¨ã“ã‚ã€å‡¦ç†æ™‚é–“ã‚’å¤§å¹…ã«çŸ­ç¸®ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

ã¨ã¦ã‚‚ä¾¿åˆ©ãª gem ãªã®ã§ã€ä»Šå›ã¯ãã®ä½¿ã„æ–¹ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚

https://rubygems.org/gems/parallel

https://github.com/grosser/parallel

## å¯¾è±¡èª­è€…

:::message
- Ruby on Rails ã‚’å­¦ç¿’ã—ã¦ã„ã‚‹æ–¹
- parallel ã«ã¤ã„ã¦èˆˆå‘³ã®ã‚ã‚‹æ–¹
- ä¸¦åˆ—å‡¦ç†ã«ã¤ã„ã¦èˆˆå‘³ã®ã‚ã‚‹æ–¹
:::

## æ³¨æ„ç‚¹

:::message alert
- å†…å®¹ã«èª¤ã‚ŠãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
- ã‚³ãƒ¡ãƒ³ãƒˆç­‰ã§æ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨å¹¸ç”šã§ã™ã€‚
:::

## ç’°å¢ƒ

:::message
- Docker Desktopï¼š4.41.2
- Docker Engineï¼š28.1.1
- Rubyï¼š3.3.5
- Railsï¼š7.0.8.6
:::

## ä¸¦åˆ—å‡¦ç†ã¨ã¯

**ä¸¦åˆ—å‡¦ç†**ã¨ã¯ã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãŒè¤‡æ•°ã® CPU ã‚³ã‚¢ã§ã€è¤‡æ•°ã®å‡¦ç†ã‚’åŒæ™‚ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æŒ‡ã—ã¾ã™ã€‚

è¤‡æ•°ã®å‡¦ç†ã‚’åŒæ™‚ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€å…¨ä½“ã®å‡¦ç†æ™‚é–“ã‚’çŸ­ç¸®ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä¼¼ãŸã‚ˆã†ãªç”¨èªã«**ä¸¦è¡Œå‡¦ç†**ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã¯ç•°ãªã‚‹æ„å‘³ã‚’æŒã¡ã¾ã™ã€‚

ä¸¦è¡Œå‡¦ç†ã¯ã€è¤‡æ•°ã®å‡¦ç†ãŒåŒæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«è¦‹ãˆã¾ã™ãŒã€å®Ÿéš›ã«ã¯1ã¤ã® CPU ã‚³ã‚¢ã§ã‚¿ã‚¹ã‚¯ã‚’åˆ‡ã‚Šæ›¿ãˆãªãŒã‚‰å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æŒ‡ã—ã¾ã™ã€‚

ä¸¦åˆ—å‡¦ç†ã€ä¸¦è¡Œå‡¦ç†ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚

https://www.zunouissiki.com/concurrent-parallel-diff/

https://www.asobou.co.jp/blog/web/concurrent-parallel

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

ã¾ãšã¯ã€Gemfile ã« parallel ã‚’è¿½åŠ ã—ã€gem ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```ruby:Gemfile
gem 'parallel'
```

```ruby:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
docker compose exec app bundle install
```

ç‰¹ã«è¨­å®šãªã©ã¯å¿…è¦ãªã„ã®ã§ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ä»¥ä¸Šã§ã™ã€‚

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä½¿ç”¨ã§ãã‚‹ CPU ã‚³ã‚¢æ•°ã‚’ç¢ºèªã—ã¦ãŠãã¾ã™ã€‚

```ruby:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
docker compose exec app rails c
Loading development environment (Rails 7.0.8.6)
irb(main):001> Parallel.processor_count
=> 5
```

ä½¿ç”¨ã§ãã‚‹ CPU ã‚³ã‚¢æ•°ãŒ 5 ã§ã‚ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

ã“ã‚Œã¯ Docker ã®è¨­å®šã«ã‚ˆã‚‹ã‚‚ã®ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/426eb648a6dd-20250531.png =1000x)

ã“ã“ã®è¨­å®šã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€ä½¿ç”¨ã§ãã‚‹ CPU ã‚³ã‚¢æ•°ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## ä½¿ç”¨ä¾‹

ã§ã¯ã€å®Ÿéš›ã« parallel ã‚’ä½¿ã£ã¦ã¿ã¾ã™ã€‚

ä»Šå›ã¯ã€parallel ã‚’ä½¿ã†å‰ã¨å¾Œã§ã€å‡¦ç†æ™‚é–“ã‚’æ¯”è¼ƒã—ã¦ã¿ã¾ã™ã€‚

### ä¸¦åˆ—å‡¦ç†ã‚’ä½¿ã‚ãªã„å ´åˆ

ã¾ãšã¯ã€ä¸¦åˆ—å‡¦ç†ã‚’ä½¿ã‚ãªã„å ´åˆã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

```ruby:lib/tasks/parallel_test.rake
# frozen_string_literal: true

namespace :test do
  desc 'parallel_test'
  task parallel_test: :environment do
    start_time = Time.now

    items = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J"]

    items.each do |item|
      (1..100).each do |i|
        puts "#{item} - #{i}"
        sleep(0.1)
      end
    end

    end_time = Time.now

    elapsed_time = end_time - start_time

    puts "å®Ÿè¡Œæ™‚é–“ï¼š#{elapsed_time.round(2)}ç§’"
  end
end
```

ã“ã¡ã‚‰ãŒä¸¦åˆ—å‡¦ç†ã‚’ä½¿ã‚ãªã„å ´åˆã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

A ã‹ã‚‰ J ã¾ã§ã®ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦ã€1 ã‹ã‚‰ 100 ã¾ã§ã®æ•°å­—ã‚’å‡ºåŠ›ã—ã€å…¨ã¦ã®ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®ãƒ«ãƒ¼ãƒ—ãŒçµ‚ã‚ã£ãŸã‚‰ã€æœ€å¾Œã«å®Ÿè¡Œæ™‚é–“ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

```ruby:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
docker compose exec app bundle exec rake test:parallel_test

A - 1
A - 2
A - 3
A - 4
A - 5
â€¢â€¢â€¢
A - 96
A - 97
A - 98
A - 99
A - 100
B - 1
B - 2
B - 3
B - 4
B - 5
â€¢â€¢â€¢
J - 96
J - 97
J - 98
J - 99
J - 100

å®Ÿè¡Œæ™‚é–“ï¼š101.57ç§’
```

ã“ã®ã‚ˆã†ãªçµæœã«ãªã‚Šã¾ã—ãŸã€‚

### ä¸¦åˆ—å‡¦ç†ã‚’ä½¿ã†å ´åˆ
æ¬¡ã«ã€parallel ã‚’ä½¿ã£ã¦ä¸¦åˆ—å‡¦ç†ã‚’è¡Œã†å ´åˆã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

```diff ruby:lib/tasks/parallel_test.rake
# frozen_string_literal: true

namespace :test do
  desc 'parallel_test'
  task parallel_test: :environment do
    start_time = Time.now

    items = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J"]

+   Parallel.map(items) do |item|
      (1..100).each do |i|
        puts "#{item} - #{i}"
        sleep(0.1)
      end
    end

    end_time = Time.now

    elapsed_time = end_time - start_time

    puts "å®Ÿè¡Œæ™‚é–“ï¼š#{elapsed_time.round(2)}ç§’"
  end
end
```

ã“ã¡ã‚‰ãŒ parallel ã‚’ä½¿ã£ã¦ä¸¦åˆ—å‡¦ç†ã‚’è¡Œã†å ´åˆã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

`items.each do |item|` ã®éƒ¨åˆ†ã‚’ `Parallel.map(items) do |item|` ã«å¤‰æ›´ã™ã‚‹ã ã‘ãªã®ã§ã€ã¨ã¦ã‚‚ç°¡å˜ã«å®Ÿè£…ã§ãã¾ã—ãŸã€‚

```ruby:ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
docker compose exec app bundle exec rake test:parallel_test

B - 1
A - 1
C - 1
D - 1
E - 1
C - 2
D - 2
E - 2
B - 2
A - 2
D - 3
E - 3
B - 3
A - 3
C - 3
C - 4
E - 4
D - 4
B - 4
A - 4
D - 5
E - 5
A - 5
B - 5
C - 5
â€¢â€¢â€¢
D - 96
B - 96
A - 96
C - 96
E - 96
B - 97
E - 97
A - 97
D - 97
C - 97
E - 98
A - 98
D - 98
C - 98
B - 98
E - 99
A - 99
B - 99
D - 99
C - 99
E - 100
A - 100
C - 100
B - 100
D - 100
F - 1
G - 1
H - 1
I - 1
J - 1
H - 2
G - 2
J - 2
I - 2
F - 2
F - 3
G - 3
I - 3
J - 3
H - 3
I - 4
J - 4
H - 4
G - 4
F - 4
J - 5
G - 5
H - 5
I - 5
F - 5
â€¢â€¢â€¢
I - 96
G - 96
H - 96
J - 96
F - 96
G - 97
I - 97
H - 97
F - 97
J - 97
I - 98
G - 98
H - 98
J - 98
F - 98
H - 99
F - 99
I - 99
J - 99
G - 99
F - 100
H - 100
J - 100
G - 100
I - 100

å®Ÿè¡Œæ™‚é–“ï¼š20.37ç§’
```

ã“ã®ã‚ˆã†ãªçµæœã«ãªã‚Šã¾ã—ãŸã€‚

å…ˆã»ã©ç¢ºèªã—ãŸé€šã‚Šã€ä½¿ç”¨ã§ãã‚‹ CPU ã‚³ã‚¢æ•°ã¯ 5 ãªã®ã§ã€5 ã¤ã®å‡¦ç†ãŒåŒæ™‚ã«å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

å‡¦ç†æ™‚é–“ã‚‚ç´„ 20 ç§’ã¨ã€ä¸¦åˆ—å‡¦ç†ã‚’ä½¿ã‚ãªã„å ´åˆã®ç´„ 100 ç§’ã‹ã‚‰ç´„ 5 åˆ†ã® 1 ã«çŸ­ç¸®ã•ã‚Œã¾ã—ãŸã€‚

## ã¾ã¨ã‚

parallel ã‚’ä½¿ã†ã“ã¨ã§ã€ç°¡å˜ã«ä¸¦åˆ—å‡¦ç†ã‚’è¡Œã†ã“ã¨ãŒã§ãã€å‡¦ç†æ™‚é–“ã‚’å¤§å¹…ã«çŸ­ç¸®ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

ä¸¦åˆ—å‡¦ç†ã¯ã€ç‰¹ã«å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†å ´åˆã‚„ã€æ™‚é–“ã®ã‹ã‹ã‚‹å‡¦ç†ã‚’è¡Œã†å ´åˆã«éå¸¸ã«æœ‰åŠ¹ã§ã™ã€‚

ãœã²è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

æœ€å¾Œã¾ã§ã”è¦§ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚
