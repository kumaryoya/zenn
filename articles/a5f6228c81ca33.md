---
title: "ã€Railsã€‘Active Recordæš—å·åŒ–ã‚’è©¦ã—ã¦ã¿ãŸ"
emoji: "ğŸ•µï¸â€â™‚ï¸"
type: "tech"
topics: [rails, ruby, activerecord, encryption, æš—å·åŒ–]
published: false
publication_name: "linkedge"
---

## ã¯ã˜ã‚ã«

ãŠç–²ã‚Œæ§˜ã§ã™ã€‚
ãŠãŠãã¾ã§ã™ã€‚

ä»Šå›ã¯ã€ã€Œã€Railsã€‘Active Recordæš—å·åŒ–ã‚’è©¦ã—ã¦ã¿ãŸã€ã¨ã„ã†ã“ã¨ã§ã€**Active Recordæš—å·åŒ–**ã«ã¤ã„ã¦ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚

å°‘ã—ã§ã‚‚çš†æ§˜ã®å‚è€ƒã«ãªã‚Šã¾ã™ã¨å¹¸ã„ã§ã™ã€‚

## å¯¾è±¡èª­è€…

:::message
- **Ruby on Rails**ã«ã¤ã„ã¦èˆˆå‘³ã®ã‚ã‚‹æ–¹
- **Active Recordæš—å·åŒ–**ã«ã¤ã„ã¦èˆˆå‘³ã®ã‚ã‚‹æ–¹
:::

## æ³¨æ„ç‚¹

:::message alert
- å†…å®¹ã«èª¤ã‚ŠãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
- ã‚³ãƒ¡ãƒ³ãƒˆç­‰ã§æ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨å¹¸ç”šã§ã™ã€‚
:::

## ç’°å¢ƒ

:::message
- Docker Desktopï¼š4.37.1
- Docker Engineï¼š27.4.0
- Rubyï¼š3.3.5
- Railsï¼š7.0.8.6
- MySQLï¼š8.0.34
:::

## Active Recordæš—å·åŒ–ã¨ã¯

**Active Recordæš—å·åŒ–**ã¨ã¯ã€ãã®åã®é€šã‚Šã€**Active Record**ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ã™ã‚‹ã“ã¨ã§ã™ã€‚
æš—å·åŒ–ã™ã‚‹å±æ€§ã‚’å®£è¨€ã™ã‚‹ã“ã¨ã§ã€**Active Record**ãŒæš—å·åŒ–ã¨å¾©å·ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãã‚Œã¾ã™ã€‚

**Active Recordæš—å·åŒ–**ã‚’ä½¿ç”¨ã™ã‚‹ç†ç”±ã¨ã—ã¦ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ãŒæš—å·åŒ–ã•ã‚Œã‚‹ãŸã‚ã€ä»®ã«æ”»æ’ƒè€…ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã¨ã—ã¦ã‚‚ã€ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹ã“ã¨ãŒã§ããªã„ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨æ€§ã‚’é«˜ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/0982db357863-20241222.png =500x)

>**[GMOã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—:æš—å·åŒ–ã¨ã¯ï¼Ÿä¸»ãªæ–¹å¼ã®ç¨®é¡ã‚„æš—å·åŒ–ãƒ»å¾©å·åŒ–ã®ä»•çµ„ã¿ã€ã‚„ã‚Šæ–¹ã«ã¤ã„ã¦è§£èª¬ã‚ˆã‚Šå¼•ç”¨](https://www.gmo.jp/security/ciphersecurity/encryption/)**

https://railsguides.jp/active_record_encryption.html

## Active Recordæš—å·åŒ–ã‚’è©¦ã—ã¦ã¿ã‚‹

ä»Šå›ã¯ã€**Article**ãƒ†ãƒ¼ãƒ–ãƒ«ã®**body**ã‚«ãƒ©ãƒ ã‚’æš—å·åŒ–ã—ã¦ã¿ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ãª**Article**ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

```ruby:app/models/article.rb
class Article < ApplicationRecord
  validates :title, presence: true, length: { maximum: 255 }
  validates :body, presence: true, length: { maximum: 65_535 }
end
```

```ruby:db/schema.rb
create_table "articles", force: :cascade do |t|
  t.string "title", null: false
  t.string "body", null: false
  t.datetime "created_at", null: false
  t.datetime "updated_at", null: false
end
```

æš—å·åŒ–ã®è¨­å®šã‚’ã™ã‚‹å‰ã«ã€**Article**ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚

```ruby
docker compose exec app rails c
Loading development environment (Rails 7.0.8.6)

irb(main):001> Article.create(title:"title", body:"body")
  TRANSACTION (0.1ms)  BEGIN /*application:TestApp*/
  Article Create (1.7ms)  INSERT INTO `articles` (`title`, `body`, `created_at`, `updated_at`) VALUES ('title', 'body', '2024-12-21 10:33:08.523552', '2024-12-21 10:33:08.523552') /*application:TestApp*/
  TRANSACTION (2.4ms)  COMMIT /*application:TestApp*/
=>
#<Article:0x0000ffff62ea87d0
 id: 1,
 title: "title",
 body: "body",
 created_at: Sat, 21 Dec 2024 19:33:08.523552000 JST +09:00,
 updated_at: Sat, 21 Dec 2024 19:33:08.523552000 JST +09:00>
```

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§**Article**ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

```ruby
docker compose exec db mysql -u root -p

mysql> USE test_app_development;
Database changed

mysql> SELECT * FROM articles ORDER BY id DESC LIMIT 1\G;
*************************** 1. row ***************************
        id: 1
     title: title
      body: body
created_at: 2024-12-21 10:33:08.523552
updated_at: 2024-12-21 10:33:08.523552
1 row in set (0.00 sec)
```

**Article**ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¦ãŠã‚Šã€å€¤ãŒæš—å·åŒ–ã•ã‚Œã¦ã„ãªã„ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

ã§ã¯ã€å®Ÿéš›ã«**Article**ãƒ†ãƒ¼ãƒ–ãƒ«ã®**body**ã‚«ãƒ©ãƒ ã‚’æš—å·åŒ–ã—ã¦ã¿ã¾ã™ã€‚

ã¾ãšã¯ã€**Active Recordæš—å·åŒ–**ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

```ruby
docker compose exec app bin/rails db:encryption:init
Add this entry to the credentials of the target environment:

active_record_encryption:
  primary_key: tVZdJ1FxwuzLMjS5yLB3cnGlJicXYIcR
  deterministic_key: UTx3Az9dnwOav4RgHpfj3IhMDbn3kFi3
  key_derivation_salt: ChRRKgQSvEdHF2u9Dn2Qpy3LKFmVgWpz
```

ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€**Active Recordæš—å·åŒ–**ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ã‚­ãƒ¼ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚

ã§ã¯ã€ã“ã‚Œã‚‰ã®ã‚­ãƒ¼ã‚’**Rails credentials**ã«è¿½åŠ ã—ã¾ã™ã€‚

```ruby
docker compose exec -e EDITOR="vim" app bin/rails credentials:edit
```

ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€**vim**ã§**Rails credentials**ãŒé–‹ã‹ã‚Œã‚‹ã®ã§ã€ã‚­ãƒ¼ã‚’è¿½åŠ ã—ã€ä¿å­˜ã—ã¾ã™ã€‚

:::message
vimã‚³ãƒãƒ³ãƒ‰ãƒ¡ãƒ¢
- iï¼šæŒ¿å…¥ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
- ESCï¼šã‚³ãƒãƒ³ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
- :wqï¼šä¿å­˜ã—ã¦çµ‚äº†
:::

```
docker compose exec app bin/rails credentials:show
# aws:
#   access_key_id: 123
#   secret_access_key: 345

# Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.
secret_key_base: 21fa33728ddd1f36b6ea28bd9bb18e8c034ca0169ce63680baefa5a2f57786fbdfae6ef9a90f0348b57b347407091ee127807b8656cbbe73682b1692dc3ad633
active_record_encryption:
  primary_key: tVZdJ1FxwuzLMjS5yLB3cnGlJicXYIcR
  deterministic_key: UTx3Az9dnwOav4RgHpfj3IhMDbn3kFi3
  key_derivation_salt: ChRRKgQSvEdHF2u9Dn2Qpy3LKFmVgWpz
```

ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€**Rails credentials**ã«ã‚­ãƒ¼ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚Œã°OKã§ã™ã€‚

æ¬¡ã«**Article**ã®ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã§ã€æš—å·åŒ–ã™ã‚‹ã‚«ãƒ©ãƒ ã‚’è¨­å®šã—ã¾ã™ã€‚
ä»Šå›ã¯ã€**body**ã‚«ãƒ©ãƒ ã‚’æš—å·åŒ–ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

```diff ruby:app/models/article.rb
class Article < ApplicationRecord
+ encrypts :body

  validates :title, presence: true, length: { maximum: 255 }
  validates :body, presence: true, length: { maximum: 65_535 }
end
```

ã“ã‚Œã§ã€**Article**ãƒ†ãƒ¼ãƒ–ãƒ«ã®**body**ã‚«ãƒ©ãƒ ãŒæš—å·åŒ–ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
å®Ÿéš›ã«**Article**ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚

```ruby
docker compose exec app rails c
Loading development environment (Rails 7.0.8.6)
irb(main):001> Article.create(title:"title", body:"body")
  TRANSACTION (0.2ms)  BEGIN /*application:TestApp*/
  Article Create (1.5ms)  INSERT INTO `articles` (`title`, `body`, `created_at`, `updated_at`) VALUES ('title', '{\"p\":\"75ciRA==\",\"h\":{\"iv\":\"JwqNkPVY+0/nPnzX\",\"at\":\"0FUpsA6IsdC5LX3lbnU1IA==\"}}', '2024-12-21 11:36:10.041893', '2024-12-21 11:36:10.041893') /*application:TestApp*/
  TRANSACTION (2.9ms)  COMMIT /*application:TestApp*/
=>
#<Article:0x0000ffff8f7a8f48
 id: 2,
 title: "title",
 body: "body",
 created_at: Sat, 21 Dec 2024 20:36:10.041893000 JST +09:00,
 updated_at: Sat, 21 Dec 2024 20:36:10.041893000 JST +09:00>
```

ç™ºè¡Œã•ã‚ŒãŸ**SQL**ãŒå‰å›ã¨ç•°ãªã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§**Article**ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

```ruby
docker compose exec db mysql -u root -p

mysql> USE test_app_development;
Database changed

mysql> SELECT * FROM articles ORDER BY id DESC LIMIT 1\G;
*************************** 1. row ***************************
        id: 2
     title: title
      body: {"p":"75ciRA==","h":{"iv":"JwqNkPVY+0/nPnzX","at":"0FUpsA6IsdC5LX3lbnU1IA=="}}
created_at: 2024-12-21 11:36:10.041893
updated_at: 2024-12-21 11:36:10.041893
1 row in set (0.00 sec)
```

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹**body**ã‚«ãƒ©ãƒ ãŒæš—å·åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

## ã¾ã¨ã‚

ä»Šå›ã€åˆã‚ã¦**Active Recordæš—å·åŒ–**ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚
æ„å¤–ã¨ç°¡å˜ã«è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

ä»Šå›ã¯ã€**Article**ãƒ†ãƒ¼ãƒ–ãƒ«ã®**body**ã‚«ãƒ©ãƒ ã‚’æš—å·åŒ–ã—ã¦ã¿ã¾ã—ãŸãŒã€å®Ÿå‹™ã§ã¯ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„ä½æ‰€ãªã©ã®å€‹äººæƒ…å ±ã‚’æš—å·åŒ–ã™ã‚‹ã“ã¨ãŒå¤šã„ã‹ã¨æ€ã„ã¾ã™ã€‚
ä¸‡ãŒä¸€ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚ŒãŸå ´åˆã®ä¿é™ºã¨ã—ã¦ã€**Active Recordæš—å·åŒ–**ã‚’ä½¿ç”¨ã—ã¦ã‚‚è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

æœ€å¾Œã¾ã§èª­ã‚“ã§ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼

## å‚è€ƒæ–‡çŒ®

https://railsguides.jp/active_record_encryption.html

https://zenn.dev/yagince/articles/2da8cc83d09136

https://www.gmo.jp/security/ciphersecurity/encryption/
