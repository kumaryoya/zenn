---
title: "ã€Railsã€‘Active Recordæš—å·åŒ–ã‚’è©¦ã—ã¦ã¿ãŸ"
emoji: "ğŸ•µï¸â€â™‚ï¸"
type: "tech"
topics: [rails, ruby, activerecord, encryption, æš—å·åŒ–]
published: false
publication_name: "linkedge"
---

## ã¯ã˜ã‚ã«

ãŠç–²ã‚Œæ§˜ã§ã™ã€‚
ãŠãŠãã¾ã§ã™ã€‚

ä»Šå›ã¯ã€ã€Œã€Railsã€‘Active Recordæš—å·åŒ–ã‚’è©¦ã—ã¦ã¿ãŸã€ã¨ã„ã†ã“ã¨ã§ã€**Active Recordæš—å·åŒ–**ã«ã¤ã„ã¦ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚

å°‘ã—ã§ã‚‚çš†æ§˜ã®å‚è€ƒã«ãªã‚Šã¾ã™ã¨å¹¸ã„ã§ã™ã€‚

## å¯¾è±¡èª­è€…

:::message
- **Ruby on Rails**ã«ã¤ã„ã¦èˆˆå‘³ã®ã‚ã‚‹æ–¹
- **Active Recordæš—å·åŒ–**ã«ã¤ã„ã¦èˆˆå‘³ã®ã‚ã‚‹æ–¹
:::

## æ³¨æ„ç‚¹

:::message alert
- å†…å®¹ã«èª¤ã‚ŠãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
- ã‚³ãƒ¡ãƒ³ãƒˆç­‰ã§æ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨å¹¸ç”šã§ã™ã€‚
:::

## ç’°å¢ƒ

:::message
- Docker Desktopï¼š4.37.1
- Docker Engineï¼š27.4.0
- Rubyï¼š3.3.5
- Railsï¼š7.0.8.6
- MySQLï¼š8.0.34
:::

## Active Recordæš—å·åŒ–ã¨ã¯

**Active Recordæš—å·åŒ–**ã¨ã¯ã€ãã®åã®é€šã‚Šã€**Active Record**ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ã™ã‚‹ã“ã¨ã§ã™ã€‚
æš—å·åŒ–ã™ã‚‹å±æ€§ã‚’å®£è¨€ã™ã‚‹ã“ã¨ã§ã€**Active Record**ãŒæš—å·åŒ–ã¨å¾©å·ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ãã‚Œã¾ã™ã€‚

**Active Recordæš—å·åŒ–**ã‚’ä½¿ç”¨ã™ã‚‹ç†ç”±ã¨ã—ã¦ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ãŒæš—å·åŒ–ã•ã‚Œã‚‹ãŸã‚ã€ä»®ã«æ”»æ’ƒè€…ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã¨ã—ã¦ã‚‚ã€ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å–ã‚‹ã“ã¨ãŒã§ããªã„ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨æ€§ã‚’é«˜ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/0982db357863-20241222.png =500x)

>**[GMOã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—:æš—å·åŒ–ã¨ã¯ï¼Ÿä¸»ãªæ–¹å¼ã®ç¨®é¡ã‚„æš—å·åŒ–ãƒ»å¾©å·åŒ–ã®ä»•çµ„ã¿ã€ã‚„ã‚Šæ–¹ã«ã¤ã„ã¦è§£èª¬ã‚ˆã‚Šå¼•ç”¨](https://www.gmo.jp/security/ciphersecurity/encryption/)**

## Active Recordæš—å·åŒ–ã‚’è©¦ã—ã¦ã¿ã‚‹

### å‰æ

ä»Šå›ã¯ã€**Article**ãƒ†ãƒ¼ãƒ–ãƒ«ã®**body**ã‚«ãƒ©ãƒ ã‚’æš—å·åŒ–ã—ã¦ã¿ã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ãª**Article**ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

```ruby:app/models/article.rb
class Article < ApplicationRecord
  validates :title, presence: true, length: { maximum: 255 }
  validates :body, presence: true, length: { maximum: 65_535 }
end
```

```ruby:db/schema.rb
create_table "articles", force: :cascade do |t|
  t.string "title", null: false
  t.string "body", null: false
  t.datetime "created_at", null: false
  t.datetime "updated_at", null: false
end
```

æš—å·åŒ–ã®è¨­å®šã‚’ã™ã‚‹å‰ã«ã€**Article**ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚

```ruby
docker compose exec app rails c
Loading development environment (Rails 7.0.8.6)

irb(main):001> Article.create(title:"title", body:"body")
  TRANSACTION (0.1ms)  BEGIN /*application:TestApp*/
  Article Create (1.7ms)  INSERT INTO `articles` (`title`, `body`, `created_at`, `updated_at`) VALUES ('title', 'body', '2024-12-22 11:47:02.622943', '2024-12-22 11:47:02.622943') /*application:TestApp*/
  TRANSACTION (2.6ms)  COMMIT /*application:TestApp*/
=>
#<Article:0x0000ffff65cf4620
 id: 1,
 title: "title",
 body: "body",
 created_at: Sun, 22 Dec 2024 20:47:02.622943000 JST +09:00,
 updated_at: Sun, 22 Dec 2024 20:47:02.622943000 JST +09:00>
```

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§**Article**ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

```ruby
docker compose exec db mysql -u root -p

mysql> USE test_app_development;
Database changed

mysql> SELECT * FROM articles\G;
*************************** 1. row ***************************
        id: 1
     title: title
      body: body
created_at: 2024-12-22 11:47:02.622943
updated_at: 2024-12-22 11:47:02.622943
1 row in set (0.00 sec)
```

**Article**ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¦ãŠã‚Šã€å€¤ãŒæš—å·åŒ–ã•ã‚Œã¦ã„ãªã„ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

ã§ã¯ã€å®Ÿéš›ã«**Article**ãƒ†ãƒ¼ãƒ–ãƒ«ã®**body**ã‚«ãƒ©ãƒ ã‚’æš—å·åŒ–ã—ã¦ã¿ã¾ã™ã€‚

### Active Recordæš—å·åŒ–ã®è¨­å®š

ã¾ãšã¯ã€**Active Recordæš—å·åŒ–**ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

```ruby
docker compose exec app bin/rails db:encryption:init
Add this entry to the credentials of the target environment:

active_record_encryption:
  primary_key: tVZdJ1FxwuzLMjS5yLB3cnGlJicXYIcR
  deterministic_key: UTx3Az9dnwOav4RgHpfj3IhMDbn3kFi3
  key_derivation_salt: ChRRKgQSvEdHF2u9Dn2Qpy3LKFmVgWpz
```

ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€**Active Recordæš—å·åŒ–**ã§ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ã‚­ãƒ¼ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚

ã§ã¯ã€ã“ã‚Œã‚‰ã®ã‚­ãƒ¼ã‚’**Rails credentials**ã«è¿½åŠ ã—ã¾ã™ã€‚

```ruby
docker compose exec -e EDITOR="vim" app bin/rails credentials:edit
```

ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€**vim**ã§**Rails credentials**ãŒé–‹ã‹ã‚Œã‚‹ã®ã§ã€ã‚­ãƒ¼ã‚’è¿½åŠ ã—ã€ä¿å­˜ã—ã¾ã™ã€‚

:::message
vimã‚³ãƒãƒ³ãƒ‰ãƒ¡ãƒ¢
- iï¼šæŒ¿å…¥ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
- ESCï¼šã‚³ãƒãƒ³ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
- :wqï¼šä¿å­˜ã—ã¦çµ‚äº†
:::

```
docker compose exec app bin/rails credentials:show
# aws:
#   access_key_id: 123
#   secret_access_key: 345

# Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.
secret_key_base: 21fa33728ddd1f36b6ea28bd9bb18e8c034ca0169ce63680baefa5a2f57786fbdfae6ef9a90f0348b57b347407091ee127807b8656cbbe73682b1692dc3ad633
active_record_encryption:
  primary_key: tVZdJ1FxwuzLMjS5yLB3cnGlJicXYIcR
  deterministic_key: UTx3Az9dnwOav4RgHpfj3IhMDbn3kFi3
  key_derivation_salt: ChRRKgQSvEdHF2u9Dn2Qpy3LKFmVgWpz
```

ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€**Rails credentials**ã«ã‚­ãƒ¼ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚Œã°OKã§ã™ã€‚

æ¬¡ã«**Article**ã®ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã§ã€æš—å·åŒ–ã™ã‚‹ã‚«ãƒ©ãƒ ã‚’è¨­å®šã—ã¾ã™ã€‚
ä»Šå›ã¯ã€**body**ã‚«ãƒ©ãƒ ã‚’æš—å·åŒ–ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

```diff ruby:app/models/article.rb
class Article < ApplicationRecord
+ encrypts :body

  validates :title, presence: true, length: { maximum: 255 }
  validates :body, presence: true, length: { maximum: 65_535 }
end
```

ã“ã‚Œã§ã€**Article**ãƒ†ãƒ¼ãƒ–ãƒ«ã®**body**ã‚«ãƒ©ãƒ ãŒæš—å·åŒ–ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
å®Ÿéš›ã«**Article**ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚

### æš—å·åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ

```
docker compose exec app rails c
Loading development environment (Rails 7.0.8.6)

irb(main):001> Article.create(title:"title", body:"body")
  TRANSACTION (0.2ms)  BEGIN /*application:TestApp*/
  Article Create (1.6ms)  INSERT INTO `articles` (`title`, `body`, `created_at`, `updated_at`) VALUES ('title', '{\"p\":\"a1rcfg==\",\"h\":{\"iv\":\"CybdD1MAo/2fxlYl\",\"at\":\"UCbsKHRL8/8jmrw6snAYSQ==\"}}', '2024-12-22 11:50:58.009958', '2024-12-22 11:50:58.009958') /*application:TestApp*/
  TRANSACTION (2.4ms)  COMMIT /*application:TestApp*/
=>
#<Article:0x0000ffff79761640
 id: 2,
 title: "title",
 body: "body",
 created_at: Sun, 22 Dec 2024 20:50:58.009958000 JST +09:00,
 updated_at: Sun, 22 Dec 2024 20:50:58.009958000 JST +09:00>
```

ç™ºè¡Œã•ã‚ŒãŸ**SQL**ãŒå‰å›ã¨ç•°ãªã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§**Article**ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

```ruby
docker compose exec db mysql -u root -p

mysql> USE test_app_development;
Database changed

mysql> SELECT * FROM articles\G;
*************************** 1. row ***************************
        id: 1
     title: title
      body: body
created_at: 2024-12-22 11:47:02.622943
updated_at: 2024-12-22 11:47:02.622943
*************************** 2. row ***************************
        id: 2
     title: title
      body: {"p":"a1rcfg==","h":{"iv":"CybdD1MAo/2fxlYl","at":"UCbsKHRL8/8jmrw6snAYSQ=="}}
created_at: 2024-12-22 11:50:58.009958
updated_at: 2024-12-22 11:50:58.009958
2 rows in set (0.00 sec)
```

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹**body**ã‚«ãƒ©ãƒ ãŒæš—å·åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

### éæš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹

ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ãŸæ®µéšã§ã€æš—å·åŒ–ã™ã‚‹ã‚ˆã†è¨­å®šã—ã¦ã„ã‚‹å ´åˆã¯ã€ç‰¹ã«å•é¡Œã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚‚ã†æ—¢ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ã¦ã„ã‚‹æ®µéšã§ã€é€”ä¸­ã‹ã‚‰æš—å·åŒ–ã®è¨­å®šã‚’è¡Œã£ãŸå ´åˆã¯ã€éæš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã¨æš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ãŒæ··åœ¨ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
æš—å·åŒ–ã®è¨­å®šã‚’è¡Œã£ã¦ã„ã‚‹çŠ¶æ…‹ã§ã€éæš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€**Active Record**ãŒéæš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å·ã—ã‚ˆã†ã¨ã™ã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

ç¾çŠ¶ã€IDãŒ1ã®**Article**ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯éæš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚
è©¦ã—ã«ã€IDãŒ1ã®**Article**ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ã€IDãŒ2ã®**Article**ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ãã‚Œãã‚Œå–å¾—ã—ã¦ã¿ã¾ã™ã€‚

```
docker compose exec app rails c
Loading development environment (Rails 7.0.8.6)

irb(main):001> Article.find(1)
  Article Load (1.0ms)  SELECT `articles`.* FROM `articles` WHERE `articles`.`id` = 1 LIMIT 1 /*application:TestApp*/
An error occurred when inspecting the object: #<ActiveRecord::Encryption::Errors::Decryption: ActiveRecord::Encryption::Errors::Decryption>

irb(main):002> Article.find(2)
  Article Load (1.5ms)  SELECT `articles`.* FROM `articles` WHERE `articles`.`id` = 2 LIMIT 1 /*application:TestApp*/
=>
#<Article:0x0000ffff658be880
 id: 2,
 title: "title",
 body: "body",
 created_at: Sun, 22 Dec 2024 20:50:58.009958000 JST +09:00,
 updated_at: Sun, 22 Dec 2024 20:50:58.009958000 JST +09:00>
```

ã“ã®ã‚ˆã†ã«ã€æš—å·åŒ–ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã™ãŒã€éæš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€**Active Record**ãŒéæš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å·ã—ã‚ˆã†ã¨ã™ã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚
ãã®ãŸã‚ã€**Active Record**ã«ã¯ã€éæš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

```diff ruby:config/application.rb
module TestApp
  class Application < Rails::Application
+   config.active_record.encryption.support_unencrypted_data = true
  end
end
```

ã“ã®ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹ã“ã¨ã§ã€éæš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

:::message alert
- ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€**éæš—å·åŒ–ãƒ‡ãƒ¼ã‚¿**ã¨**æš—å·åŒ–æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿**ãŒæ··åœ¨ã™ã‚‹ã“ã¨ã‚’è¨±å¯ã—ã¦ã—ã¾ã†ãŸã‚ã€ã‚ãã¾ã§ç§»è¡ŒæœŸé–“ã®ã¿è¨­å®šã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™
:::

ã§ã¯ã€å†åº¦**Article**ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã¦ã¿ã¾ã™ã€‚

```
docker compose exec app rails c
Loading development environment (Rails 7.0.8.6)
irb(main):001> Article.first
  Article Load (0.5ms)  SELECT `articles`.* FROM `articles` ORDER BY `articles`.`id` ASC LIMIT 1 /*application:TestApp*/
=>
#<Article:0x0000ffff678c2988
 id: 3,
 title: "title",
 body: "body",
 created_at: Sun, 22 Dec 2024 08:28:27.019603000 JST +09:00,
 updated_at: Sun, 22 Dec 2024 08:28:27.019603000 JST +09:00>

docker compose exec app rails c
Loading development environment (Rails 7.0.8.6)

irb(main):001> Article.find(1)
  Article Load (0.4ms)  SELECT `articles`.* FROM `articles` WHERE `articles`.`id` = 1 LIMIT 1 /*application:TestApp*/
=>
#<Article:0x0000ffff9315ca28
 id: 1,
 title: "title",
 body: "body",
 created_at: Sun, 22 Dec 2024 20:47:02.622943000 JST +09:00,
 updated_at: Sun, 22 Dec 2024 20:47:02.622943000 JST +09:00>

irb(main):002> Article.find(2)
  Article Load (1.2ms)  SELECT `articles`.* FROM `articles` WHERE `articles`.`id` = 2 LIMIT 1 /*application:TestApp*/
=>
#<Article:0x0000ffff93885980
 id: 2,
 title: "title",
 body: "body",
 created_at: Sun, 22 Dec 2024 20:50:58.009958000 JST +09:00,
 updated_at: Sun, 22 Dec 2024 20:50:58.009958000 JST +09:00>
```

ç„¡äº‹ã€**Article**ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

### éæš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ã™ã‚‹

ç¾çŠ¶ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã¨éæš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ãŒæ··åœ¨ã—ã¦ã„ã¾ã™ã€‚

```ruby
docker compose exec db mysql -u root -p

mysql> USE test_app_development;
Database changed

mysql> SELECT * FROM articles\G;
*************************** 1. row ***************************
        id: 1
     title: title
      body: body
created_at: 2024-12-22 11:47:02.622943
updated_at: 2024-12-22 11:47:02.622943
*************************** 2. row ***************************
        id: 2
     title: title
      body: {"p":"a1rcfg==","h":{"iv":"CybdD1MAo/2fxlYl","at":"UCbsKHRL8/8jmrw6snAYSQ=="}}
created_at: 2024-12-22 11:50:58.009958
updated_at: 2024-12-22 11:50:58.009958
2 rows in set (0.00 sec)
```

éæš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’æš—å·åŒ–ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«**Active Record**ã‚’ä½¿ç”¨ã—ã¦æš—å·åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ruby
docker compose exec app rails c
Loading development environment (Rails 7.0.8.6)

irb(main):001> Article.all.map(&:encrypt)
  Article Load (2.7ms)  SELECT `articles`.* FROM `articles` /*application:TestApp*/
  TRANSACTION (0.1ms)  BEGIN /*application:TestApp*/
  Article Update (1.1ms)  UPDATE `articles` SET `articles`.`body` = '{\"p\":\"CNXG0g==\",\"h\":{\"iv\":\"ConRjMsP+GNfsD4F\",\"at\":\"XucI7X82OnjrfsrMoH5cnw==\"}}' WHERE `articles`.`id` = 1 /*application:TestApp*/
  TRANSACTION (4.2ms)  COMMIT /*application:TestApp*/
  TRANSACTION (0.1ms)  BEGIN /*application:TestApp*/
  Article Update (0.4ms)  UPDATE `articles` SET `articles`.`body` = '{\"p\":\"TFR5og==\",\"h\":{\"iv\":\"gSszdP/4VDBF7XFW\",\"at\":\"gQ2Cgw337rtLWDlTqs9xIA==\"}}' WHERE `articles`.`id` = 2 /*application:TestApp*/
  TRANSACTION (1.3ms)  COMMIT /*application:TestApp*/
=> [nil, nil]
```

ã“ã‚Œã§ã€æ—¢å­˜ã®éæš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ãŒæš—å·åŒ–ã•ã‚Œã¾ã—ãŸã€‚

å®Ÿéš›ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§**Article**ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

```ruby
docker compose exec db mysql -u root -p

mysql> USE test_app_development;
Database changed

mysql> SELECT * FROM articles ORDER BY id DESC LIMIT 1\G;
*************************** 1. row ***************************
        id: 3
     title: title
      body: {"p":"lKLKpg==","h":{"iv":"48g5SHXH1KPMpnmG","at":"jJwYtDm7BW39tGoBgvtMog=="}}
created_at: 2024-12-21 23:28:27.019603
updated_at: 2024-12-21 23:28:27.019603
1 row in set (0.00 sec)

docker compose exec db mysql -u root -p

mysql> USE test_app_development;
Database changed

mysql> SELECT * FROM articles\G;
*************************** 1. row ***************************
        id: 1
     title: title
      body: {"p":"CNXG0g==","h":{"iv":"ConRjMsP+GNfsD4F","at":"XucI7X82OnjrfsrMoH5cnw=="}}
created_at: 2024-12-22 11:47:02.622943
updated_at: 2024-12-22 11:47:02.622943
*************************** 2. row ***************************
        id: 2
     title: title
      body: {"p":"TFR5og==","h":{"iv":"gSszdP/4VDBF7XFW","at":"gQ2Cgw337rtLWDlTqs9xIA=="}}
created_at: 2024-12-22 11:50:58.009958
updated_at: 2024-12-22 11:50:58.009958
2 rows in set (0.00 sec)
```

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹**body**ã‚«ãƒ©ãƒ ãŒæš—å·åŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

## ã¾ã¨ã‚

ä»Šå›ã€åˆã‚ã¦**Active Recordæš—å·åŒ–**ã‚’è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚
æ„å¤–ã¨ç°¡å˜ã«è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

ä»Šå›ã¯ã€**Article**ãƒ†ãƒ¼ãƒ–ãƒ«ã®**body**ã‚«ãƒ©ãƒ ã‚’æš—å·åŒ–ã—ã¦ã¿ã¾ã—ãŸãŒã€å®Ÿå‹™ã§ã¯ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚„ä½æ‰€ãªã©ã®å€‹äººæƒ…å ±ã‚’æš—å·åŒ–ã™ã‚‹ã“ã¨ãŒå¤šã„ã‹ã¨æ€ã„ã¾ã™ã€‚
ä¸‡ãŒä¸€ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚ŒãŸå ´åˆã®ä¿é™ºã¨ã—ã¦ã€**Active Recordæš—å·åŒ–**ã‚’ä½¿ç”¨ã—ã¦ã‚‚è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

æœ€å¾Œã¾ã§èª­ã‚“ã§ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼

## å‚è€ƒæ–‡çŒ®

https://railsguides.jp/active_record_encryption.html

<!-- https://zenn.dev/yagince/articles/2da8cc83d09136 -->

https://www.gmo.jp/security/ciphersecurity/encryption/
