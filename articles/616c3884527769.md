---
title: "ã€Railsã€‘primary_key(ä¸»ã‚­ãƒ¼)ã‚’ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã«ã™ã‚‹"
emoji: "ğŸ”‘"
type: "tech"
topics: [rails, ruby, mysql, security, docker]
published: false
publication_name: "linkedge"
---

## ã¯ã˜ã‚ã«

ãŠç–²ã‚Œæ§˜ã§ã™ã€‚
ãŠãŠãã¾ã§ã™ã€‚

ä»Šå›ã¯ã€ã€Œã€Railsã€‘primary_key(ä¸»ã‚­ãƒ¼)ã‚’ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã«ã™ã‚‹ã€ã¨ã„ã†ã“ã¨ã§ã€**Ruby on Rails**ã§ã€**primary_key**ã‚’ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã«ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚

å°‘ã—ã§ã‚‚çš†æ§˜ã®å‚è€ƒã«ãªã‚Šã¾ã™ã¨å¹¸ã„ã§ã™ã€‚

## å¯¾è±¡èª­è€…

:::message
- **Ruby on Rails**ã‚’å­¦ç¿’ä¸­ã®æ–¹
- **primary_key**ã‚’ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã«ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„æ–¹
:::

## æ³¨æ„ç‚¹

:::message alert
- å†…å®¹ã«èª¤ã‚ŠãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
- ã‚³ãƒ¡ãƒ³ãƒˆç­‰ã§æ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨å¹¸ç”šã§ã™ã€‚
:::

## ç’°å¢ƒ

:::message
- Docker Desktopï¼š4.34.2
- Docker Engineï¼š27.2.0
- Rubyï¼š3.3.4
- Railsï¼š7.0.8.4
- MySQLï¼š8.0.39
:::

## primary_key(ä¸»ã‚­ãƒ¼)ã¨ã¯

**primary_key**ã¨ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãŠã„ã¦ã€å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä¸€æ„ã«è­˜åˆ¥ã™ã‚‹ãŸã‚ã®ã‚­ãƒ¼ã®ã“ã¨ã§ã™ã€‚
ãã®ãŸã‚ã€**primary_key**ã¯ã€é‡è¤‡ã™ã‚‹å€¤ã‚’æŒã¤ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚
**Ruby on Rails**ã§ã¯ã€ç‰¹ã«æŒ‡å®šã—ãªã„å ´åˆã€**id**ã‚«ãƒ©ãƒ ãŒ**primary_key**ã¨ã—ã¦è¨­å®šã•ã‚Œã€1ã€ï¼’ã€ï¼“ã€ï¼”ã€ï¼•ã€ãƒ»ãƒ»ãƒ»ã¨ã„ã†ã‚ˆã†ã«ã€é€£ç•ªã§å€¤ãŒè¨­å®šã•ã‚Œã¾ã™ã€‚

https://www.sejuku.net/blog/52356

## ãªãœprimary_key(ä¸»ã‚­ãƒ¼)ã‚’ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã«ã™ã‚‹ã®ã‹

**Ruby on Rails**ã§ã¯ã€`/posts/:id/edit`ã®ã‚ˆã†ãªURLã‚’ç”Ÿæˆã™ã‚‹éš›ã«ã€**id**ã‚«ãƒ©ãƒ ã®å€¤ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
å…ˆã»ã©ã‚‚è¿°ã¹ãŸé€šã‚Šã€**id**ã‚«ãƒ©ãƒ ã¯é€šå¸¸ã€1ã€ï¼’ã€ï¼“ã€ï¼”ã€ï¼•ã€ãƒ»ãƒ»ãƒ»ã¨ã„ã†ã‚ˆã†ã«ã€é€£ç•ªã§å€¤ãŒè¨­å®šã•ã‚Œã‚‹ã®ã§ã€ãƒ‘ã‚¹ãŒæ¨æ¸¬ã•ã‚Œã‚„ã™ããªã‚Šã¾ã™ã€‚

```ruby:app/controllers/posts_controller.rb
def edit
  @post = current_user.posts.find(params[:id])
end
```

```ruby:app/controllers/posts_controller.rb
def edit
  @post = Post.find(params[:id])
end
```

1ã¤ç›®ã®ä¾‹ã®ã‚ˆã†ã«ã€`current_user`èµ·ç‚¹ã§ã€`Post`ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹å ´åˆã¯ã€ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®idã®å€¤ã‚’æ‰“ã¡å¤‰ãˆãŸã¨ã—ã¦ã‚‚ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿ã‚’ç·¨é›†ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚

ã—ã‹ã—ã€ä¸‡ãŒä¸€ã€2ã¤ç›®ã®ä¾‹ã®ã‚ˆã†ã«ã€`Post`ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã™ã‚‹å ´åˆã¯ã€ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®idã®å€¤ã‚’æ‰“ã¡å¤‰ãˆã‚‹ã“ã¨ã§ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿ã‚’ç·¨é›†ã™ã‚‹ã“ã¨ãŒã§ãã¦ã—ã¾ã„ã¾ã™ã€‚

é–‹ç™ºã‚’é€²ã‚ã‚‹ä¸­ã§ã€ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®idã‚’æ‰“ã¡å¤‰ãˆãŸã¨ã—ã¦ã‚‚ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æŠ•ç¨¿ã‚’ç·¨é›†ã™ã‚‹ã“ã¨ãŒã§ããªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã€1ã¤ç›®ã®ä¾‹ã®ã‚ˆã†ã«å¯¾ç­–ã‚’ã™ã‚‹ã“ã¨ã‚‚é‡è¦ã§ã™ãŒã€ãã‚‚ãã‚‚æ¨æ¸¬ã•ã‚Œã«ãã„ã‚ˆã†ãªãƒ‘ã‚¹ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã‚‚é‡è¦ã§ã™ã€‚

ãã“ã§ã€**primary_key**ã‚’ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã«ã™ã‚‹ã“ã¨ã§ã€ãƒ‘ã‚¹ã‚’æ¨æ¸¬ã•ã‚Œã«ããã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## primary_key(ä¸»ã‚­ãƒ¼)ã‚’ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã«ã™ã‚‹æ–¹æ³•

ç’°å¢ƒæ§‹ç¯‰ãŒæ¸ˆã‚“ã§ã„ã‚‹æ®µéšã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚

```ruby:app/models/concerns/id_generate_module.rb
module IdGenerateModule
  extend ActiveSupport::Concern

  included do
    before_create :generate, if: -> { has_attribute?(:id) }
  end

  def generate
    self.id ||= loop do
      id = SecureRandom.hex(5)
      break id unless self.class.exists?(id: id)
    end
  end
end
```

ã¾ãšã¯ã€`app/models/concerns`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`id_generate_module.rb`ã¨ã„ã†ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

`id = SecureRandom.hex(5)`ã®éƒ¨åˆ†ã§ã€ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚
æ‹¬å¼§å†…ã®æ•°å­—ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€ç”Ÿæˆã•ã‚Œã‚‹æ–‡å­—åˆ—ã®é•·ã•ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä»Šå›ã¯ã€10æ–‡å­—ã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```diff ruby:app/models/application_record.rb
class ApplicationRecord < ActiveRecord::Base
+ include IdGenerateModule
  primary_abstract_class
end
```

æ¬¡ã«ã€`app/models/application_record.rb`ã«`IdGenerateModule`ã‚’ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

ã§ã¯ã€å®Ÿéš›ã«ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```
docker compose run app rails new . --force --no-deps --database=mysql --skip-test
```

æ¬¡ã«ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¾ã™ã€‚

```diff ruby:db/migrate/20240914035018_create_posts.rb
class CreatePosts < ActiveRecord::Migration[7.0]
  def change
+   create_table :posts, id: :string, limit: 10 do |t|
-   create_table :posts do |t|
      t.string :title
      t.text :content

      t.timestamps
    end
  end
end
```

ã“ã®ã‚ˆã†ã«ç·¨é›†ã™ã‚‹ã“ã¨ã§ã€`posts`ãƒ†ãƒ¼ãƒ–ãƒ«ã®`id`ã‚«ãƒ©ãƒ ã®å‹ã‚’`string`ã«å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã§ã¯ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã€å®Ÿéš›ã«`posts`ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```
docker compose run app rails db:migrate
```

```ruby:db/schema.rb
ActiveRecord::Schema[7.0].define(version: 2024_09_14_035018) do
  create_table "posts", id: { type: :string, limit: 10 }, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.string "title"
    t.text "content"
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
  end

end
```

`posts`ãƒ†ãƒ¼ãƒ–ãƒ«ã®`id`ã‚«ãƒ©ãƒ ã®å‹ãŒ`string`ã«å¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

ã§ã¯ã€å®Ÿéš›ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```ruby:config/routes.rb
Rails.application.routes.draw do
  root 'posts#index'
  resources :posts
end
```

ã“ã®ã‚ˆã†ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å®šç¾©ã—ã€ http://localhost:3000/ ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/88388e14df31-20240914.png =500x)

ã“ã“ã‹ã‚‰ã€New Postã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€æ–°è¦æŠ•ç¨¿ã‚’ä½œæˆã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/9f56109f5afa-20240914.png =500x)

![](https://storage.googleapis.com/zenn-user-upload/6f28035ae6d7-20240914.png =500x)

ç„¡äº‹ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚

ã§ã¯ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§idã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```ruby
docker compose run app rails c

irb(main):001> Post.first
  Post Load (0.7ms)  SELECT `posts`.* FROM `posts` ORDER BY `posts`.`id` ASC LIMIT 1
=>
#<Post:0x0000ffff66c0d7b0
  id: "6494ac5f80",
  title: "ã‚¿ã‚¤ãƒˆãƒ«",
  content: "æœ¬æ–‡",
  created_at: Sat, 14 Sep 2024 05:01:39.153767000 UTC +00:00,
  updated_at: Sat, 14 Sep 2024 05:01:39.153767000 UTC +00:00>
```

ç„¡äº‹ã«idãŒãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/ebcceae79835-20240914.png =500x)

![](https://storage.googleapis.com/zenn-user-upload/d021e50f7d2a-20240914.png =500x)

å®Ÿéš›ã«ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹URLã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
```ruby
è©³ç´°ãƒšãƒ¼ã‚¸ï¼š`http://localhost:3000/posts/6494ac5f80`
ç·¨é›†ãƒšãƒ¼ã‚¸ï¼š`http://localhost:3000/posts/6494ac5f80/edit`
```

