---
title: "【Rails】primary_key(主キー)をランダムな文字列にする"
emoji: "🔑"
type: "tech"
topics: [rails, ruby, mysql, security, docker]
published: false
publication_name: "linkedge"
---

## はじめに

お疲れ様です。
おおくまです。

今回は、「【Rails】primary_key(主キー)をランダムな文字列にする」ということで、**Ruby on Rails**で、**primary_key**をランダムな文字列にする方法についてまとめてみました。

少しでも皆様の参考になりますと幸いです。

## 対象読者

:::message
- **Ruby on Rails**を学習中の方
- **primary_key**をランダムな文字列にする方法について知りたい方
:::

## 注意点

:::message alert
- 内容に誤りがある場合があります。
- コメント等で教えていただけると幸甚です。
:::

## 環境

:::message
- Docker Desktop：4.34.2
- Docker Engine：27.2.0
- Ruby：3.3.4
- Rails：7.0.8.4
- MySQL：8.0.39
:::

## primary_key(主キー)とは

**primary_key**とは、データベースのテーブルにおいて、各レコードを一意に識別するためのキーのことです。
そのため、**primary_key**は、重複する値を持つことができません。
**Ruby on Rails**では、特に指定しない場合、**id**カラムが**primary_key**として設定され、1、２、３、４、５、・・・というように、連番で値が設定されます。

https://www.sejuku.net/blog/52356

## なぜprimary_key(主キー)をランダムな文字列にするのか

**Ruby on Rails**では、`/posts/:id/edit`のようなURLを生成する際に、**id**カラムの値を使用します。
先ほども述べた通り、**id**カラムは通常、1、２、３、４、５、・・・というように、連番で値が設定されるので、パスが推測されやすくなります。

```ruby:app/controllers/posts_controller.rb
def edit
  @post = current_user.posts.find(params[:id])
end
```

```ruby:app/controllers/posts_controller.rb
def edit
  @post = Post.find(params[:id])
end
```

1つ目の例のように、`current_user`起点で、`Post`テーブルからレコードを取得する場合は、アドレスバーのidの値を打ち変えたとしても、他のユーザーの投稿を編集することはできません。

しかし、万が一、2つ目の例のように、`Post`テーブルからレコードを取得する場合は、アドレスバーのidの値を打ち変えることで、他のユーザーの投稿を編集することができてしまいます。

開発を進める中で、アドレスバーのidを打ち変えたとしても、他のユーザーの投稿を編集することができないようにするために、1つ目の例のように対策をすることも重要ですが、そもそも推測されにくいようなパスを生成することも重要です。

そこで、**primary_key**をランダムな文字列にすることで、パスを推測されにくくすることができます。

## primary_key(主キー)をランダムな文字列にする方法

環境構築が済んでいる段階からスタートします。

```ruby:app/models/concerns/id_generate_module.rb
module IdGenerateModule
  extend ActiveSupport::Concern

  included do
    before_create :generate, if: -> { has_attribute?(:id) }
  end

  def generate
    self.id ||= loop do
      id = SecureRandom.hex(5)
      break id unless self.class.exists?(id: id)
    end
  end
end
```

まずは、`app/models/concerns`ディレクトリに`id_generate_module.rb`というランダムな文字列を生成するためのモジュールを作成します。

`id = SecureRandom.hex(5)`の部分で、ランダムな文字列を生成しています。
括弧内の数字を変更することで、生成される文字列の長さを変更することができます。
今回は、10文字のランダムな文字列を生成するようにしています。

```diff ruby:app/models/application_record.rb
class ApplicationRecord < ActiveRecord::Base
+ include IdGenerateModule
  primary_abstract_class
end
```

次に、`app/models/application_record.rb`に`IdGenerateModule`をインクルードします。

では、実際にモデルを作成してみましょう。

```
docker compose run app rails new . --force --no-deps --database=mysql --skip-test
```

次に、マイグレーションファイルを編集します。

```diff ruby:db/migrate/20240914035018_create_posts.rb
class CreatePosts < ActiveRecord::Migration[7.0]
  def change
+   create_table :posts, id: :string, limit: 10 do |t|
-   create_table :posts do |t|
      t.string :title
      t.text :content

      t.timestamps
    end
  end
end
```

このように編集することで、`posts`テーブルの`id`カラムの型を`string`に変更することができます。

では、マイグレーションを実行し、実際に`posts`テーブルを作成してみましょう。

```
docker compose run app rails db:migrate
```

```ruby:db/schema.rb
ActiveRecord::Schema[7.0].define(version: 2024_09_14_035018) do
  create_table "posts", id: { type: :string, limit: 10 }, charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.string "title"
    t.text "content"
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
  end

end
```

`posts`テーブルの`id`カラムの型が`string`に変更されていることが確認できます。

では、実際にレコードを作成してみましょう。

```ruby:config/routes.rb
Rails.application.routes.draw do
  root 'posts#index'
  resources :posts
end
```

このようにルーティングを定義し、 http://localhost:3000/ にアクセスします。

![](https://storage.googleapis.com/zenn-user-upload/88388e14df31-20240914.png =500x)

ここから、New Postをクリックし、新規投稿を作成します。

![](https://storage.googleapis.com/zenn-user-upload/9f56109f5afa-20240914.png =500x)

![](https://storage.googleapis.com/zenn-user-upload/6f28035ae6d7-20240914.png =500x)

無事にレコードが作成されました。

では、コンソールでidを確認してみましょう。

```ruby
docker compose run app rails c

irb(main):001> Post.first
  Post Load (0.7ms)  SELECT `posts`.* FROM `posts` ORDER BY `posts`.`id` ASC LIMIT 1
=>
#<Post:0x0000ffff66c0d7b0
  id: "6494ac5f80",
  title: "タイトル",
  content: "本文",
  created_at: Sat, 14 Sep 2024 05:01:39.153767000 UTC +00:00,
  updated_at: Sat, 14 Sep 2024 05:01:39.153767000 UTC +00:00>
```

無事にidがランダムな文字列になっていることが確認できました。

![](https://storage.googleapis.com/zenn-user-upload/ebcceae79835-20240914.png =500x)

![](https://storage.googleapis.com/zenn-user-upload/d021e50f7d2a-20240914.png =500x)

実際に生成されているURLは以下のようになっています。
```ruby
詳細ページ：`http://localhost:3000/posts/6494ac5f80`
編集ページ：`http://localhost:3000/posts/6494ac5f80/edit`
```

