---
title: "ã€Railsã€‘gemä½¿ã£ã¦ã¿ãŸã‚·ãƒªãƒ¼ã‚º ã€œbulletç·¨ã€œ N+1å•é¡Œã‚’å¯è¦–åŒ–"
emoji: "ğŸ”«"
type: "tech"
topics: [rails, ruby, gem, bullet, sql]
published: false
publication_name: "linkedge"
---

## ã¯ã˜ã‚ã«

ãŠç–²ã‚Œæ§˜ã§ã™ã€‚
ãŠãŠãã¾ã§ã™ã€‚

ä»Šå›ã¯ã€ã€Œã€Railsã€‘gemä½¿ã£ã¦ã¿ãŸã‚·ãƒªãƒ¼ã‚º ã€œbulletç·¨ã€œ N+1å•é¡Œã‚’å¯è¦–åŒ–ã€ã¨ã„ã†ã“ã¨ã§ã€**Ruby on Rails**ã§ã€**bullet**ã¨ã„ã†**gem**ã‚’ä½¿ã£ã¦ã€**N+1å•é¡Œ**ã‚’å¯è¦–åŒ–ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã€ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚

å°‘ã—ã§ã‚‚çš†æ§˜ã®å‚è€ƒã«ãªã‚Šã¾ã™ã¨å¹¸ã„ã§ã™ã€‚

## å¯¾è±¡èª­è€…

:::message
- **Ruby on Rails**ã«ã¤ã„ã¦èˆˆå‘³ã®ã‚ã‚‹æ–¹
- **bullet**ã«ã¤ã„ã¦èˆˆå‘³ã®ã‚ã‚‹æ–¹
- **N+1å•é¡Œ**ã«ã¤ã„ã¦èˆˆå‘³ã®ã‚ã‚‹æ–¹
:::

## æ³¨æ„ç‚¹

:::message alert
- å†…å®¹ã«èª¤ã‚ŠãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
- ã‚³ãƒ¡ãƒ³ãƒˆç­‰ã§æ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨å¹¸ç”šã§ã™ã€‚
:::

## ç’°å¢ƒ

:::message
- Docker Desktopï¼š4.38.0
- Docker Engineï¼š27.5.1
- Rubyï¼š3.3.5
- Railsï¼š7.0.8.6
:::

## N+1å•é¡Œã¨ã¯

**N+1å•é¡Œ**ã¨ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ä¸è¦ãªã‚¯ã‚¨ãƒªãŒå¤§é‡ã«ç™ºç”Ÿã™ã‚‹ã“ã¨ã§ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä½ä¸‹ã™ã‚‹å•é¡Œã®ã“ã¨ã§ã™ã€‚

ãã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é«˜è² è·ãŒã‹ã‹ã£ã¦ã—ã¾ã£ãŸã‚Šã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒé…ããªã£ã¦ã—ã¾ã£ãŸã‚Šã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

**Ruby on Rails**ã«ãŠã„ã¦ã¯ã€**ActiveRecord**ã®é–¢é€£(`belongs_to`ã‚„`has_many`)ã‚’æ‰±ã†ã¨ãã«ç™ºç”Ÿã—ã‚„ã™ã„ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/e76985dbc481-20250211.webp =250x)

### ç™ºç”Ÿä¾‹

ä»¥ä¸‹ã®ã‚ˆã†ãª`User`ãƒ†ãƒ¼ãƒ–ãƒ«ã¨`Post`ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚

```ruby:db/schema.rb
ActiveRecord::Schema[7.0].define(version: 2024_12_21_083443) do
  create_table "posts", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.bigint "user_id", null: false
    t.string "title", null: false
    t.text "content", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["user_id"], name: "index_posts_on_user_id"
  end

  create_table "users", charset: "utf8mb4", collation: "utf8mb4_0900_ai_ci", force: :cascade do |t|
    t.string "name", null: false
    t.string "email", null: false
    t.integer "age", null: false
    t.string "login_id", null: false
    t.string "encrypted_password", null: false
    t.datetime "created_at", null: false
    t.datetime "updated_at", null: false
    t.index ["email"], name: "index_users_on_email", unique: true
    t.index ["login_id"], name: "index_users_on_login_id", unique: true
  end

  add_foreign_key "posts", "users"
end
```

```ruby:app/models/user.rb
class User < ApplicationRecord
  has_many :posts, dependent: :destroy
end
```

```ruby:app/models/post.rb
class Post < ApplicationRecord
  belongs_to :user
end
```

ã“ã“ã§ã€`Post`ä¸€è¦§ç”»é¢ã‚’ä½œæˆã—ã€ã‚ã–ã¨**N+1å•é¡Œ**ã‚’ç™ºç”Ÿã•ã›ã¦ã¿ã¾ã™ã€‚

```ruby:app/controllers/posts_controller.rb
class PostsController < ApplicationController
  def index
    @posts = Post.all.order(id: :asc)
  end
end
```

```ruby:app/views/posts/index.html.slim
div.p-5
  h1.mb-3 æŠ•ç¨¿ä¸€è¦§
  p style="color: green" = notice
  = link_to "æ–°è¦è¿½åŠ ", new_post_path, class: 'btn btn-outline-info btn-sm m-3'
  .d-flex.flex-wrap.align-items-center
    - @posts.each do |post|
      .card.border.m-3 style="width: 400px;"
        .card-header.h5 = post.title
        .card-body
          .float-right
            button.copy-button.btn.btn-outline-secondary.btn-sm data-target="post_#{post.id}"
              i.far.fa-copy.mr-1
              span.copy-text ã‚³ãƒ”ãƒ¼
          div
            .mb-3 = post.user.name
          div id="post_#{post.id}"
            .mb-3 = post.content
          = link_to "è©³ç´°", post, class: 'btn btn-outline-secondary btn-sm mr-1'
          - if current_user.id == post.user_id
            = link_to "ç·¨é›†", edit_post_path(post), class: 'btn btn btn-outline-info btn-sm mr-1'
            = link_to "å‰Šé™¤", post, method: :delete, data: { turbo: "true", turbo_method: :delete, turbo_confirm: 'å‰Šé™¤ã—ã¾ã™ã‹?' }, class: "btn btn-outline-danger btn-sm"
```

ã“ã®ã‚ˆã†ã«ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§ã¯`Post`ã®æƒ…å ±ã®ã¿ã‚’å–å¾—ã—ã€ãƒ“ãƒ¥ãƒ¼ã‚’æç”»ã™ã‚‹éš›ã«ã€å€‹ã€…ã«`User`ã®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã‚‹ãŸã‚ã€**N+1å•é¡Œ**ãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚

ã‚ã‚ã›ã¦ã€ç™ºè¡Œã•ã‚ŒãŸã‚¯ã‚¨ãƒªã‚‚ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

```ruby:log/development.log
Processing by PostsController#index as HTML
  [1m[36mUser Load (2.5ms)[0m  [1m[34mSELECT `users`.* FROM `users` WHERE `users`.`id` = 1 ORDER BY `users`.`id` ASC LIMIT 1 /*application:TestApp,controller:posts,action:index*/[0m
  â†³ app/controllers/application_controller.rb:9:in `authenticate_user!'
  Rendering layout layouts/application.html.slim
  Rendering posts/index.html.slim within layouts/application
  [1m[36mPost Load (0.6ms)[0m  [1m[34mSELECT `posts`.* FROM `posts` ORDER BY `posts`.`id` ASC /*application:TestApp,controller:posts,action:index*/[0m
  â†³ app/views/posts/index.html.slim:6
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT `users`.* FROM `users` WHERE `users`.`id` = 1 LIMIT 1 /*application:TestApp,controller:posts,action:index*/[0m
  â†³ app/views/posts/index.html.slim:15
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT `users`.* FROM `users` WHERE `users`.`id` = 2 LIMIT 1 /*application:TestApp,controller:posts,action:index*/[0m
  â†³ app/views/posts/index.html.slim:15
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT `users`.* FROM `users` WHERE `users`.`id` = 3 LIMIT 1 /*application:TestApp,controller:posts,action:index*/[0m
  â†³ app/views/posts/index.html.slim:15
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT `users`.* FROM `users` WHERE `users`.`id` = 4 LIMIT 1 /*application:TestApp,controller:posts,action:index*/[0m
  â†³ app/views/posts/index.html.slim:15
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT `users`.* FROM `users` WHERE `users`.`id` = 5 LIMIT 1 /*application:TestApp,controller:posts,action:index*/[0m
  â†³ app/views/posts/index.html.slim:15
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT `users`.* FROM `users` WHERE `users`.`id` = 6 LIMIT 1 /*application:TestApp,controller:posts,action:index*/[0m
  â†³ app/views/posts/index.html.slim:15
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT `users`.* FROM `users` WHERE `users`.`id` = 7 LIMIT 1 /*application:TestApp,controller:posts,action:index*/[0m
  â†³ app/views/posts/index.html.slim:15
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT `users`.* FROM `users` WHERE `users`.`id` = 8 LIMIT 1 /*application:TestApp,controller:posts,action:index*/[0m
  â†³ app/views/posts/index.html.slim:15
  [1m[36mUser Load (0.1ms)[0m  [1m[34mSELECT `users`.* FROM `users` WHERE `users`.`id` = 9 LIMIT 1 /*application:TestApp,controller:posts,action:index*/[0m
  â†³ app/views/posts/index.html.slim:15
  Rendered posts/index.html.slim within layouts/application (Duration: 13.3ms | Allocations: 7565)
  Rendered layout layouts/application.html.slim (Duration: 29.2ms | Allocations: 11491)
Completed 200 OK in 61ms (Views: 28.9ms | ActiveRecord: 5.7ms | Allocations: 12857)
```

ãƒ“ãƒ¥ãƒ¼ã‚’æç”»ã™ã‚‹éš›ã«ã€`User`ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦ã€`Post`ã®æ•°ã ã‘ã‚¯ã‚¨ãƒªãŒç™ºè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

`Post`ã®æ•°ãŒå¢—ãˆã‚‹ã»ã©ã€ç™ºè¡Œã•ã‚Œã‚‹ã‚¯ã‚¨ãƒªã®æ•°ã‚‚å¢—ãˆã¦ã—ã¾ã†ãŸã‚ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä½ä¸‹ã—ã¦ã—ã¾ã„ã¾ã™ã€‚

### è§£æ±ºæ–¹æ³•

ä»Šå›ã®ä¾‹ã§ã¯ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§`Post`ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹éš›ã«ã€`User`ã®æƒ…å ±ã‚‚ä¸€ç·’ã«å–å¾—ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã™ã‚‹ã“ã¨ã§ã€**N+1å•é¡Œ**ã‚’è§£æ¶ˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```diff ruby:app/controllers/posts_controller.rb
class PostsController < ApplicationController
  def index
+   @posts = Post.includes(:user).all.order(id: :asc)
  end
end
```

```ruby:log/development.log
Processing by PostsController#index as HTML
  [1m[36mUser Load (1.6ms)[0m  [1m[34mSELECT `users`.* FROM `users` WHERE `users`.`id` = 1 ORDER BY `users`.`id` ASC LIMIT 1 /*application:TestApp,controller:posts,action:index*/[0m
  â†³ app/controllers/application_controller.rb:9:in `authenticate_user!'
  Rendering layout layouts/application.html.slim
  Rendering posts/index.html.slim within layouts/application
  [1m[36mPost Load (0.4ms)[0m  [1m[34mSELECT `posts`.* FROM `posts` ORDER BY `posts`.`id` ASC /*application:TestApp,controller:posts,action:index*/[0m
  â†³ app/views/posts/index.html.slim:6
  [1m[36mUser Load (0.3ms)[0m  [1m[34mSELECT `users`.* FROM `users` WHERE `users`.`id` IN (1, 2, 3, 4, 5, 6, 7, 8, 9) /*application:TestApp,controller:posts,action:index*/[0m
  â†³ app/views/posts/index.html.slim:6
  Rendered posts/index.html.slim within layouts/application (Duration: 18.3ms | Allocations: 7235)
  Rendered layout layouts/application.html.slim (Duration: 57.7ms | Allocations: 37078)
Completed 200 OK in 79ms (Views: 57.9ms | ActiveRecord: 3.4ms | Allocations: 41825)
```

ç™ºè¡Œã•ã‚ŒãŸã‚¯ã‚¨ãƒªã®æ•°ãŒæ¸›ã£ãŸã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã‚’å°‘ã—ä¿®æ­£ã™ã‚‹ã ã‘ã§ã€**N+1å•é¡Œ**ã‚’è§£æ¶ˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

ã—ã‹ã—ã€æ™®æ®µã€ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ã‚‹ä¸­ã§ã€**N+1å•é¡Œ**ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’æŠŠæ¡ã™ã‚‹ã“ã¨ã¯é›£ã—ã„ã§ã™ã€‚

ãã“ã§ã€**bullet**ã¨ã„ã†**gem**ã‚’ä½¿ã†ã“ã¨ã§ã€**N+1å•é¡Œ**ã‚’å¯è¦–åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## bulletã¨ã¯

**bullet**ã¯ã€**N+1å•é¡Œ**ã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®**gem**ã§ã™ã€‚

**bullet**ã‚’å°å…¥ã™ã‚‹ã“ã¨ã§ã€**N+1å•é¡Œ**ãŒç™ºç”Ÿã—ãŸéš›ã«æ•™ãˆã¦ãã‚Œã‚‹ãŸã‚ã€**N+1å•é¡Œ**ã‚’è§£æ¶ˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://github.com/flyerhzm/bullet

## å°å…¥æ–¹æ³•

ã¾ãšã€**Gemfile**ã«**bullet**ã‚’è¿½åŠ ã—ã€`bundle install`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

æ¬¡ã«ã€`bundle exec rails g bullet:install`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

ãã†ã™ã‚‹ã¨ã€`config/environments/development.rb`ã«ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚

```ruby:config/environments/development.rb
Rails.application.configure do
  config.after_initialize do
    Bullet.enable        = true
    Bullet.alert         = true
    Bullet.bullet_logger = true
    Bullet.console       = true
    Bullet.rails_logger  = true
    Bullet.add_footer    = true
  end
end
```

ä»–ã«ã‚‚æ§˜ã€…ãªè¨­å®šãŒã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šã§é€²ã‚ã¦ã„ãã¾ã™ã€‚

:::message
- **Bullet.enable**ï¼š**bullet**ã‚’æœ‰åŠ¹åŒ–
- **Bullet.alert**ï¼š**N+1å•é¡Œ**ã‚’ç™ºè¦‹ã—ãŸã‚‰ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
- **Bullet.bullet_logger**ï¼š**log/bullet.log**ã«ãƒ­ã‚°ã‚’å‡ºåŠ›
- **Bullet.console**ï¼šé–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
- **Bullet.rails_logger**ï¼š**log/development.log**ã«ãƒ­ã‚°ã‚’å‡ºåŠ›
- **Bullet.add_footer**ï¼šãƒ•ãƒƒã‚¿ãƒ¼ã«ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
:::

ã“ã‚Œã§ã€**bullet**ã®å°å…¥ãŒå®Œäº†ã—ã¾ã—ãŸã€‚

## N+1å•é¡Œã‚’å¯è¦–åŒ–

å…ˆã»ã©ä¿®æ­£ã—ãŸ`Post`ä¸€è¦§ç”»é¢ã§ã€**N+1å•é¡Œ**ã‚’å†åº¦ã€ç™ºç”Ÿã•ã›ã¦ã¿ã¾ã™ã€‚

```diff ruby:app/controllers/posts_controller.rb
class PostsController < ApplicationController
  def index
+   @posts = Post.all.order(id: :asc)
  end
end
```

`Post`ä¸€è¦§ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹ã¨ã€**N+1å•é¡Œ**ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã“ã¨ãŒå¯è¦–åŒ–ã•ã‚Œã¾ã™ã€‚

### ã‚¢ãƒ©ãƒ¼ãƒˆ

![](https://storage.googleapis.com/zenn-user-upload/59c8b7374429-20250211.png =500x)

`Post`ä¸€è¦§ç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹ã¨ã€ã‚¢ãƒ©ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚

### log/bullet.log

```ruby:log/bullet.log
2025-02-11 17:24:22[WARN] user: root
GET /
USE eager loading detected
  Post => [:user]
  Add to your query: .includes([:user])
Call stack
  /test_app/app/views/posts/index.html.slim:15:in `block in _app_views_posts_index_html_slim___3451928325704220638_26000'
  /test_app/app/views/posts/index.html.slim:6:in `_app_views_posts_index_html_slim___3451928325704220638_26000'
```

`log/bullet.log`ã«ã‚‚ã€ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚

### é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«

![](https://storage.googleapis.com/zenn-user-upload/9fe2b00afe98-20250211.png =500x)

é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚ã€ã‚¢ãƒ©ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚

### log/development.log

```ruby:log/development.log
user: root
GET /
USE eager loading detected
  Post => [:user]
  Add to your query: .includes([:user])
Call stack
  /test_app/app/views/posts/index.html.slim:15:in `block in _app_views_posts_index_html_slim___3451928325704220638_26000'
  /test_app/app/views/posts/index.html.slim:6:in `_app_views_posts_index_html_slim___3451928325704220638_26000'
```

`log/development.log`ã«ã‚‚ã€ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚

### ãƒ•ãƒƒã‚¿ãƒ¼

![](https://storage.googleapis.com/zenn-user-upload/be9b68d6ed27-20250211.png =500x)

ãƒ•ãƒƒã‚¿ãƒ¼ã«ã‚‚ã€ã‚¢ãƒ©ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚

## ã¾ã¨ã‚

ä»Šå›ã€**N+1å•é¡Œ**ã‚„ã€**N+1å•é¡Œ**ã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®**gem**ã§ã‚ã‚‹**bullet**ã«ã¤ã„ã¦ã€ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚

å°å…¥ã‚‚ç°¡å˜ã§ã€**N+1å•é¡Œ**ã‚’å¯è¦–åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãŸã‚ã€é–‹ç™ºä¸­ã«**N+1å•é¡Œ**ãŒç™ºç”Ÿã—ã¦ã—ã¾ã£ã¦ã‚‚ã€ã™ãã«æ°—ã¥ãã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã¡ã‚‰ã‚’å‚è€ƒã«ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã¦ã¿ã¦ãã ã•ã„ã€‚

å°‘ã—ã§ã‚‚çš†æ§˜ã®å‚è€ƒã«ãªã‚Šã¾ã™ã¨å¹¸ã„ã§ã™ã€‚

æœ€å¾Œã¾ã§èª­ã‚“ã§ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚
